name: Deploy Backend to EC2

on:
  push:
    branches: main

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Key change: Matches frontend's SSH setup exactly
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.EC2_SSH_KEY }}
          known_hosts: ${{ secrets.EC2_HOST }}  # Changed from placeholder
          config: |
            Host ${{ secrets.EC2_HOST }}
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null

      - name: Validate Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 400 key.pem
          ssh-keygen -lf key.pem  # Verify fingerprint matches frontend

      - name: Deploy & Restart Backend
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            # Debug: Show current user and permissions
            echo "â„¹ï¸ Current user: $(whoami)"
            echo "â„¹ï¸ Home directory contents:"
            ls -la ~/

            echo "âž¡ï¸  Navigating to backend directory..."
            cd ~/backend/linkedin-scrape-data || {
              echo "âŒ Error: Backend directory not found!";
              ls -la ~/backend;
              exit 1;
            }

            # Debug: Show git status before pull
            echo "â„¹ï¸ Git status before pull:"
            git status

            echo "ðŸ”„ Pulling latest code..."
            git pull origin main

            echo "ðŸ“¦ Installing dependencies..."
            npm install

            [ -f requirements.txt ] && pip install -r requirements.txt

            echo "ðŸš€ PM2 Management..."
            if pm2 list | grep -q backend; then
              pm2 restart backend
            else
              pm2 start server.js --name backend
            fi
            pm2 save
            pm2 logs backend --lines 5 --nostream

            echo "âœ… Backend deployment complete!"
          EOF
